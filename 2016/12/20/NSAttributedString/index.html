<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>NSAttributedString的坑 | iMemo的技术博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="问题爱墨笔记里用到了NSAttributedString，这里没有用到他的富文本显示，倒是用到了他的转换功能，我需要将HTML转换成文本，代码示例如下:
123[[NSAttributedString alloc] initWithData:originData options:@&amp;#123; NSDocumentTypeDocumentAttribute: NSHTMLTextDocumentT">
<meta property="og:type" content="article">
<meta property="og:title" content="NSAttributedString的坑">
<meta property="og:url" content="http://blog.imemo8.com/2016/12/20/NSAttributedString/index.html">
<meta property="og:site_name" content="iMemo的技术博客">
<meta property="og:description" content="问题爱墨笔记里用到了NSAttributedString，这里没有用到他的富文本显示，倒是用到了他的转换功能，我需要将HTML转换成文本，代码示例如下:
123[[NSAttributedString alloc] initWithData:originData options:@&amp;#123; NSDocumentTypeDocumentAttribute: NSHTMLTextDocumentT">
<meta property="og:updated_time" content="2016-12-22T15:48:22.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="NSAttributedString的坑">
<meta name="twitter:description" content="问题爱墨笔记里用到了NSAttributedString，这里没有用到他的富文本显示，倒是用到了他的转换功能，我需要将HTML转换成文本，代码示例如下:
123[[NSAttributedString alloc] initWithData:originData options:@&amp;#123; NSDocumentTypeDocumentAttribute: NSHTMLTextDocumentT">
  
    <link rel="alternate" href="/atom.xml" title="iMemo的技术博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">iMemo的技术博客</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">记录技术点滴</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="/about">About</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://blog.imemo8.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-NSAttributedString" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/12/20/NSAttributedString/" class="article-date">
  <time datetime="2016-12-20T14:53:14.000Z" itemprop="datePublished">2016-12-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/iOS/">iOS</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      NSAttributedString的坑
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p><a href="https://itunes.apple.com/cn/app/ai-mo-ri-ji-jian-jie-bian/id912688184?mt=8" target="_blank" rel="external">爱墨笔记</a>里用到了NSAttributedString，这里没有用到他的富文本显示，倒是用到了他的转换功能，我需要将HTML转换成文本，代码示例如下:</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[[<span class="built_in">NSAttributedString</span> alloc] initWithData:originData </span><br><span class="line">options:@&#123; <span class="built_in">NSDocumentTypeDocumentAttribute</span>: <span class="built_in">NSHTMLTextDocumentType</span> &#125; </span><br><span class="line">documentAttributes:<span class="literal">nil</span> error:<span class="literal">nil</span>];</span><br></pre></td></tr></table></figure>
<p>其实是一段很普通的代码，但是通过Bug的监测，我们会发现这句话会偶尔闪退，为了解决这个问题查阅了很多资料,网络上对这个的讨论还是比较多的，证明确实存在一些问题，首先我们需要了解的是NSAttributedString实现原理是什么。</p>
<a id="more"></a>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>首先我们引用官方对NSAttributedString initWithData方法的解释:</p>
<blockquote>
<p>The HTML importer should not be called from a background thread (that is, the options dictionary includes NSDocumentTypeDocumentAttribute with a value of NSHTMLTextDocumentType). It will try to synchronize with the main thread, fail, and time out. Calling it from the main thread works (but can still time out if the HTML contains references to external resources, which should be avoided at all costs). The HTML import mechanism is meant for implementing something like markdown (that is, text styles, colors, and so on), not for general HTML import.</p>
</blockquote>
<p>从以上解释能看出，我们使用的时候不能用多线程，只能用主线程，否则会出问题，<strong>但是我们经过实测，在iOS8.3以下会Crash,iOS8.3以上就没问题，所以这个问题大家要注意了</strong>。</p>
<p>第二个需要弄明白的是他是如何将HTML渲染出来，他是通过Webkit要做渲染的，通过DOM这种方式来完成最终渲染，所以这种方式的性能不会很理想。<br>为什么会知道是通过Webkit渲染的，是通过报错的Stack来确认的:<br><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> WebKitLegacy	-[_WebSafeForwarder forwardInvocation:] + <span class="number">132</span></span><br><span class="line"><span class="number">2</span> CoreFoundation	____forwarding___ + <span class="number">404</span></span><br><span class="line"><span class="number">3</span> CoreFoundation	_CF_forwarding_prep_0 + <span class="number">92</span></span><br><span class="line"><span class="number">4</span> CoreFoundation	___invoking___ + <span class="number">144</span></span><br><span class="line"><span class="number">5</span> CoreFoundation	-[NSInvocation invoke] + <span class="number">284</span></span><br><span class="line"><span class="number">6</span> WebCore	HandleDelegateSource(<span class="keyword">void</span>*) + <span class="number">108</span></span><br><span class="line"><span class="number">7</span> CoreFoundation	___CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__ + <span class="number">24</span></span><br><span class="line"><span class="number">8</span> CoreFoundation	___CFRunLoopDoSources0 + <span class="number">412</span></span><br><span class="line"><span class="number">9</span> CoreFoundation	___CFRunLoopRun + <span class="number">804</span></span><br><span class="line"><span class="number">10</span> CoreFoundation	CFRunLoopRunSpecific + <span class="number">444</span></span><br><span class="line"><span class="number">11</span> UIFoundation	-[NSHTMLReader _loadUsingWebKit] + <span class="number">1860</span></span><br><span class="line"><span class="number">12</span> UIFoundation	-[NSHTMLReader attributedString] + <span class="number">28</span></span><br><span class="line"><span class="number">13</span> UIFoundation	_NSReadAttributedStringFromURLOrData + <span class="number">4688</span></span><br></pre></td></tr></table></figure></p>
<h2 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h2><p>根据以上的问题分析，在频繁的使用NSAttributedString的情况下，他的可靠性和性能都是不行的，所以我个人比较推荐以下两个方案:</p>
<h4 id="纯手动的方式解析HTML转化成文本"><a href="#纯手动的方式解析HTML转化成文本" class="headerlink" title="纯手动的方式解析HTML转化成文本"></a>纯手动的方式解析HTML转化成文本</h4><p>这种方式就是通过解析标签，拿出自己想要的，这种方案仅限将HTML转化成纯文本<br><a href="https://github.com/renegade78/MWFeedParser/blob/master/Classes/NSString%2BHTML.h" target="_blank" rel="external">示例代码</a></p>
<h4 id="DTCoreText"><a href="#DTCoreText" class="headerlink" title="DTCoreText"></a>DTCoreText</h4><p>是一个基于CoreText的第三方库，在文字处理能力很强大，他的不是基于Webkit的，所以性能是很大的优点,缺点就是功能过于强大，其实我们只用到了已小部分功能，而且我们要入两个Framework,给程序的启动增加了一定的时间.</p>
<p>代码示例:<br><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSString</span> *htmlStripped = </span><br><span class="line">[[<span class="built_in">NSAttributedString</span> attributedStringWithHTML:DATA_FOR_MY_HTML options:<span class="literal">nil</span>] string];</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://blog.imemo8.com/2016/12/20/NSAttributedString/" data-id="ciwxo72v00000strutbr7tm0o" class="article-share-link">Share</a>
      
        <a href="http://blog.imemo8.com/2016/12/20/NSAttributedString/#disqus_thread" class="article-comment-link">留言</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NSAttributedString/">NSAttributedString</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ThreadSafe/">ThreadSafe</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Webkit/">Webkit</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2016/07/21/iOS-cache-reference/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">缓存对象有没被引用</div>
    </a>
  
</nav>

  
</article>


<section id="comments">
  <div id="disqus_thread">
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
</section>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Cocos2d/">Cocos2d</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/iOS/">iOS</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/AFNetworking/">AFNetworking</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Architecture/">Architecture</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Block/">Block</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cocos2d-iOS/">Cocos2d-iOS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Cycle/">Cycle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MVC/">MVC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Modes/">Modes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NSArray/">NSArray</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NSAttributedString/">NSAttributedString</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NSDictionary/">NSDictionary</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NSSet/">NSSet</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Runloop/">Runloop</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Specifications/">Specifications</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Sprite/">Sprite</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ThreadSafe/">ThreadSafe</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Webkit/">Webkit</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cache/">cache</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iOS/">iOS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/reference/">reference</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/retaincount/">retaincount</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/异步加载/">异步加载</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/AFNetworking/" style="font-size: 10px;">AFNetworking</a> <a href="/tags/Architecture/" style="font-size: 20px;">Architecture</a> <a href="/tags/Block/" style="font-size: 10px;">Block</a> <a href="/tags/Cocos2d-iOS/" style="font-size: 10px;">Cocos2d-iOS</a> <a href="/tags/Cycle/" style="font-size: 10px;">Cycle</a> <a href="/tags/MVC/" style="font-size: 10px;">MVC</a> <a href="/tags/Modes/" style="font-size: 10px;">Modes</a> <a href="/tags/NSArray/" style="font-size: 10px;">NSArray</a> <a href="/tags/NSAttributedString/" style="font-size: 10px;">NSAttributedString</a> <a href="/tags/NSDictionary/" style="font-size: 10px;">NSDictionary</a> <a href="/tags/NSSet/" style="font-size: 10px;">NSSet</a> <a href="/tags/Runloop/" style="font-size: 10px;">Runloop</a> <a href="/tags/Specifications/" style="font-size: 10px;">Specifications</a> <a href="/tags/Sprite/" style="font-size: 10px;">Sprite</a> <a href="/tags/ThreadSafe/" style="font-size: 10px;">ThreadSafe</a> <a href="/tags/Webkit/" style="font-size: 10px;">Webkit</a> <a href="/tags/cache/" style="font-size: 10px;">cache</a> <a href="/tags/iOS/" style="font-size: 10px;">iOS</a> <a href="/tags/reference/" style="font-size: 10px;">reference</a> <a href="/tags/retaincount/" style="font-size: 10px;">retaincount</a> <a href="/tags/异步加载/" style="font-size: 10px;">异步加载</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">十二月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">七月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">六月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">五月 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">四月 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/12/20/NSAttributedString/">NSAttributedString的坑</a>
          </li>
        
          <li>
            <a href="/2016/07/21/iOS-cache-reference/">缓存对象有没被引用</a>
          </li>
        
          <li>
            <a href="/2016/06/26/cocos2d-web-image/">Cocos2d-iOS网络加载图片</a>
          </li>
        
          <li>
            <a href="/2016/05/30/iOS-specifications/">iOS开发规范</a>
          </li>
        
          <li>
            <a href="/2016/04/29/iOS-MVC/">iOS之MVC</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Jezz<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav>
    
<script>
  var disqus_shortname = 'imemo8';
  
  var disqus_url = 'http://blog.imemo8.com/2016/12/20/NSAttributedString/';
  
  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>


<script src="/js/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>